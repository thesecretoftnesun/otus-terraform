# Terraform 
 
В ходе выполнения домашнего задания к занятию "Тестирование инфраструктурного кода на Terraform" были созданы тесты, проверяющие корректно ли созданы ресурсы при помощи терраформ-манифестов. 
Сначала мы настроили Yandex.Cloud, создали дополнительный каталог в Yandex.Cloud и подготовили рабочую станцию для последующей работы, т.е. установили на рабочую станцию GoLang. 
Инструкцию по установке на различные ОС можно найти тут: https://golang.org/doc/install 
## Создание тестов. 
Для проведения тестирования мы использовали Go-библиотеку - Terratest.  
Более подробную информацию о Terratest вы сможете найти на сайте https://terratest.gruntwork.io/docs. 
Сначала создали новую ветку в репозитории и перешли в нее. Затем в файле output.tf изменили вывод переменной load_balancer_public_ip и добавили еще одну переменную для определения IP одной из виртуальных машин 
## Terratest 
### Инициализация проекта 
В подкаталоге test создали файл end2end_test.go, в результате в каталоге появился файл go.mod, где храняться ссылки на библиотеки, которые будут необходимы для работы тестов.  
### Создание инфраструктуры 
Так как одна из основных задач Terratest создавать и удалять тестируемые ресурсы, то мы начали с того, чтобы дополнить end2end_test.go необходимыми для этого командами. Тут мы определили переменную folder, которая будет принимать значение ID каталога, где будут создаваться ресурсы. Как мы помните, мы хотели это делать в каталоге stage Yandex.Cloud. ID каталога мы будем передавать его в качестве опции/флага в команде запуска тестов.  
При помощи выражения defer мы вызываем функцию terraform.Destroy после завершения наших тестов. Т.е. когда свою работу завершит функция TestEndToEndDeploymentScenario. Выводим в консоль дополнительные индикаторы происходящих процессов и задаем небольшую паузу, в течении которой мы сможем сходить в веб-консоль Yandex.Cloud и убедиться, что ресурсы действительно созданы. В секцию import мы помещаем все необходимые нам библиотеки, включая непосредственно terratest "github.com/gruntwork-io/terratest/modules/terraform". 
Запускаем тест, указав в качестве опций время за которое он должен выполниться (почему мы вынуждены это сделать можно узнать тут: https://terratest.gruntwork.io/docs/testing-best-practices/timeouts-and-logging/) и передадим ID каталога stage.   
### Управление стадиями тестирования
Разные стадии прохождения процесса тестирования (создание инфраструктуры, собственно тесты, удаление инфраструктуры) мы “обернули” в специальную функцию test_structure.RunTestStage. 
Упоминаются несколько переменных окружения, имя которых состоит из префикса “SKIP_” и имени стадии. И именно при помощи этих переменных мы можем управлять тем, будет ли выполняться та или иная стадия, или нет.

Далее пишем тесты, которые выполняют проверку наличия IP Load balancer-а в state-е терраформа, возможность подключиться по ssh к одной из виртуальных машин, возможность подключения к базе данных.

## Вывод: 
В финале, проверим полный цикл прохождения всех стадий. Все тесты были пройдены успешно.